<!DOCTYPE html>
<html lang="pt-br">

<head>
    <!-- Base -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>GameUp - Profile</title>

    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css?family=Titillium+Web&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Rokkitt&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css"
        integrity="sha384-lZN37f5QGtY3VHgisS14W3ExzMWZxybE1SJSEsQp9S+oqd12jhcu+A56Ebc1zFSJ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <!-- Css -->
    <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/styleProfiles.css">
    <link rel="stylesheet" href="./node_modules/font-awesome/css/font-awesome.min.css">

</head>

<body>

    <!-- Cabeçalho -->
    <header>

        <!-- Barra de navegação -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="home.html"><img src="./img/logo.png" alt="logo gameup"></a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="home.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="profile.html">Profile</a>
                    </li>
                </ul>
                <form class="form-inline my-2 my-lg-0">
                    <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                    <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
                </form>
            </div>
            <a class="btn btn-primary mr-2" id="loginSignInButton" href="./login.html">Login / SignIn</a>
            <span class="d-flex" id="helloUser">
                <p id="userHello">Bem vindo</p>
                <p class="ml-1" id="userName">nome</p>
            </span>
            <a class="btn btn-danger ml-3" id="logout" onclick="logout()">Sair</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
        </nav> <!-- Barra de navegação -->
    </header> <!-- Cabeçalho -->

    <!-- Principal -->
    <main style="margin: 50px 0;">

        <!-- Container do principal -->
        <div class="container">

            <!-- Linha titular -->
            <div class="row">

                <!-- Coluna única -->
                <div class="col-sm-12 text-center" id="bemvindo">

                    <h2>Bem vindo ao seu perfil</h2>

                </div> <!-- Coluna única -->

            </div> <!-- Linha titular -->

            <!-- Linha única do principal -->
            <div class="row">

                <!-- Coluna 1 -->
                <div class="col-sm-5" style="border-right: 1px solid rgb(211, 211, 211);">

                    <img src="img/pic.png" alt="">
                    <H2><span id="userIdTag"></span></H2>

                </div> <!-- Coluna 1 -->

                <!-- Coluna 2 -->
                <div class="col-sm-7">

                    <div>

                        <p>Conecte suas contas</p>
                        <a href="https://store.steampowered.com/?l=portuguese" class="fab fa-steam"
                            style="color:#171a21;"></a>
                        <a href="https://store.playstation.com/pt-br/home/games" class="fab fa-playstation"
                            style="color: #2E6DB4;"></a>
                        <a href="https://www.xbox.com/pt-BR/microsoft-store" class="fab fa-xbox"
                            style="color:  #107C11;"></a>
                        <a href="https://www.twitch.tv/" class="fab fa-twitch" style="color: #6441A4;"></a>
                        <a href="https://www.youtube.com/?hl=pt&gl=BR" class="fab fa-youtube" style="color: red;"></a>


                    </div>

                </div> <!-- Coluna 2 -->

            </div> <!-- Linha única do principal -->

        </div> <!-- Container do principal -->

    </main> <!-- Principal -->

    <!--modal nivel-->
    <div class="levels container">
        <div class="row mb-2 ml-1">
            <button type="button" class="btn btn-success" id="addLevelButton">Adicionar nível</button>
        </div>

        <div class="card mb-5" id="addLevel">
            <div class="card-body">
                <h4 class="text-success" id="nivelAdicionado">Nível adicionado com sucesso</h4>
                <h4 class="text-danger" id="nivelErroCampos">Cheque todos os campos</h4>
                <h4 class="text-danger" id="nivelErroTotal">Algo de errado aconteceu tente novamente</h4>
                <form onsubmit="saveLevel();return false" id="formAddLevel">
                    <div class="d-flex">
                        <input type="number" name="userId" id="userId" class="d-none">
                        <select class="form-control w-25 mr-3" id="listGames" name="jogo">
                            <option>Selecione o jogo</option>
                        </select>
                        <input class="form-control w-25 mr-3" placeholder="Digite seu nivel" name="level">
                        <input type="number" class="form-control w-25 mr-3" placeholder="Digite a variação do nivel"
                            name="levelVariation">

                        <button type="submit" class="btn btn-primary form-control w-25">Adicionar</button>
                    </div>
                </form>
            </div>
        </div>
        <hr>
        <h3 id="semCadastro">Nenhum nível cadastrado</h3>
        <ul id="levelList">
        </ul>
    </div>

    <!-- Rodapé -->
    <footer>

        <!-- Container do rodapé -->
        <div class="container">

            <!-- Linha única do rodapé -->
            <div class="row">

                <!-- Coluna única do rodapé -->
                <div class="col-sm-12">

                    &copy; GameUp 2019

                </div> <!-- Coluna única do rodapé -->

            </div> <!-- Linha única do rodapé -->

        </div> <!-- Container do rodapé -->

    </footer> <!-- Rodapé -->

    <!-- Script bootstrap -->
    <script src="./node_modules/jquery/dist/jquery.min.js"></script>
    <script src="./node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script>
        var userData;
        var gameList;
        var status = 'desativado';
        var selectedToDelete;
        var idDeleteLevel;
        $(document).ready(function () {
            $('#nivelAdicionado').hide()
            $('#nivelErroCampos').hide()
            $('#nivelErroTotal').hide()
            $('.cofirm-delete').hide()
            $('#addLevel').hide()
            $('#semCadastro').hide()
            console.log(selectedToDelete)
            if (window.sessionStorage.getItem('userId')) {
                var userId = window.sessionStorage.getItem('userId')
                $('#loginSignInButton').hide()
                getUserInfo(userId)
            } else {
                $('#userHello').hide()
                $('#userName').hide()
                $('#logout').hide()
            }

            $('#addLevelButton').click(function () {
                if (status == 'desativado') {
                    $('#addLevel').show()
                    status = 'ativado'
                } else {
                    $('#addLevel').hide()
                    status = 'desativado'
                }
            })
            $('#userId').val(window.sessionStorage.getItem('userId'))
            getGames()
            getLevels()
        })

        function getLevels() {
            $.ajax({
                'method': 'POST',
                'data': {
                    'userId': window.sessionStorage.getItem('userId')
                },
                'url': './api/getUserLevels.php',
                'success': function (res) {
                    $('#leveList').empty()
                    let data = JSON.parse(res)
                    console.log(data)
                    if (res.length == 2) {
                        $('#semCadastro').show()
                    } else {
                        $('#semCadastro').hide()
                        for (let i = 0; i < data.length; i++) {
                            let html =
                                '<div class="card mb-3"><div class="card-body"><div class="d-flex justify-content-between"><h5 class="card-title">' +
                                data[i][1] + '</h5><button class="btn btn-danger" id="level' + data[i][3] +
                                '" onclick="deleteLevel(' + data[i][3] +
                                ')"><i class="fas fa-trash" id="icon' + data[i][3] +
                                '"></i></button></div><p class="card-text">Nível: ' +
                                data[i][2] + '</p><p class="card-text">Variação: ' + data[i][0] +
                                '</p></div></div>'
                            $('#levelList').append(html)
                        }

                    }
                },
                'error': function (res) {
                    console.log(res)
                    $('#nivelErroTotal').show()
                }
            })
        }

        function resetLevels() {
            $('#levelList').empty()
            getLevels()
        }

        function deleteLevel(idLevel) {
            idDeleteLevel = idLevel
            console.log(idLevel)
            console.log(selectedToDelete)
            if (idLevel == selectedToDelete || selectedToDelete == undefined) {

                $('#level' + idLevel).removeClass('btn-danger')
                $('#level' + idLevel).addClass('btn-success')
                $('#icon' + idLevel).removeClass('fa-trash')
                $('#icon' + idLevel).addClass('fa-check')
                if (!$('#conf-deletar').length) {
                    $('#level' + idLevel).prepend('<span id="conf-deletar">Confirme para deletar</span> ')
                }

                let time = setTimeout(function(){
                    $('#level' + idDeleteLevel).addClass('btn-danger')
                    $('#level' + idDeleteLevel).removeClass('btn-success')
                    $('#icon' + idDeleteLevel).removeClass('fa-check')
                    $('#icon' + idDeleteLevel).addClass('fa-trash')
                    $('#conf-deletar').remove()
                    selectedToDelete = undefined
                }, 5000)

                if (idLevel == selectedToDelete) {
                    clearTimeout(time)
                    $.ajax({
                        'method': 'POST',
                        'data': {
                            idlevel: idLevel
                        },
                        'url': './api/deleteLevel.php',
                        'success': function (res) {
                            console.log(res)
                            if (res == 1) {
                                $('#nivelAdicionado').show()
                            } else if (res == 0) {
                                $('#nivelErroTotal').show()
                            }
                            resetLevels()
                        },
                        'error': function (res) {
                            console.log(res)
                        }
                    })
                }
            } else {
                $('#level' + selectedToDelete).addClass('btn-danger')
                $('#icon' + selectedToDelete).addClass('fa-trash')
                $('#level' + selectedToDelete).removeClass('btn-success')
                $('#icon' + selectedToDelete).removeClass('fa-check')
                $('#conf-deletar').remove()

                $('#level' + idLevel).removeClass('btn-danger')
                $('#level' + idLevel).addClass('btn-success')
                $('#icon' + idLevel).removeClass('fa-trash')
                $('#icon' + idLevel).addClass('fa-check')
                $('#level' + idLevel).prepend('<span id="conf-deletar">Clique para deletar</span> ')
            }
            selectedToDelete = idLevel
        }

        function saveLevel() {
            const values = $('#formAddLevel').serializeArray()
            console.log(values)
            if (values[0].value == '' || values[1].value == '' || values[2].value == '' || values[3].value == '') {
                $('#nivelErroCampos').show()
            } else {
                $.ajax({
                    'method': 'POST',
                    'data': values,
                    'url': './api/saveLevel.php',
                    'success': function (res) {
                        console.log(res)
                        if (res == 1) {
                            $('#nivelAdicionado').show()
                        } else if (res == 0) {
                            $('#nivelErroTotal').show()
                        }

                        resetLevels()
                    },
                    'error': function (res) {
                        console.log(res)
                        $('#nivelErroTotal').show()
                    }
                })

            }

        }

        function getGames() {
            $.ajax({
                'method': 'POST',
                'url': './api/getGameName.php',
                'success': function (res) {
                    gameList = JSON.parse(res)
                    for (let i = 0; i < gameList.length; i++) {
                        $('#listGames').append('<option value="' + gameList[i][0] + '">' + gameList[i][1] +
                            '</option>')
                    }
                },
                'error': function (res) {
                    console.log(res)
                }
            })
        }

        function getUserInfo(userId) {
            $.ajax({
                'method': 'POST',
                'url': './api/getUserInfo.php',
                'data': {
                    'id': userId
                },

                'success': function (res) {
                    userData = JSON.parse(res)
                    console.log(userData)
                    window.sessionStorage.setItem('userName', userData.userName)
                    $('#userName').text(userData.userName)
                    $('#userIdTag').append(userData.userName)
                },
                'error': function (res) {
                    console.log(res)
                }
            })
        }

        function logout(params) {
            window.sessionStorage.removeItem('userName')
            window.sessionStorage.removeItem('userId')
            location.reload()
        }

        function addLevel() {
            console.log('112123123')
        }
    </script>
</body>

</html>